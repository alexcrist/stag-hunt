<!doctype html>
<html>
  <head>
    <title>Stag Hunt</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas" width=1400 height=700></canvas>
    <script src="/socket.io/socket.io.js"></script>

    <script>

      const MAP_WIDTH = 1400;
      const MAP_HEIGHT = 700;

      const CENTER_X = MAP_WIDTH / 2;;
      const CENTER_Y = MAP_HEIGHT / 2;
      const ON_KEY_DOWN = "keydown";
      const ON_KEY_UP = "keyup";
      const EVENT = "event";
      const CONNECT = "connect";
      const WORLDSTATE = "worldstate";
      const ENTITY_TYPES = {
        PLAYER: "player",
        RABBIT: "rabbit",
        STAG: "stag"
      };

      const socket = io();
      let socketId;

      const drawEntity = (entity, myPosition) => {
        // Get the canvas
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");

        // Get the entity data
        const entityPosition = entity.position;
        let x = entityPosition.x - myPosition.x + CENTER_X;
        let y = entityPosition.y - myPosition.y + CENTER_Y;
        if (x < 0) {
          x = MAP_WIDTH + x;
        } else if (x > MAP_WIDTH) {
          x = 0 + x - MAP_WIDTH;
        }

        if (y > MAP_HEIGHT) {
          y = 0 + y - MAP_HEIGHT;
        } else if (y < 0) {
          y = MAP_HEIGHT + y;
        }

        x = x * window.innerWidth / MAP_WIDTH;
        y = y * window.innerHeight / MAP_HEIGHT;

        let playerSize = null;

        // Draw the entity
        switch (entity.type) {
          case ENTITY_TYPES.PLAYER:
            context.fillStyle = entity.color;
            playerSize = 10;
            break;
          case ENTITY_TYPES.RABBIT:
            context.fillStyle = "rgb(196, 188, 183)";
            playerSize = 8;
            break;
          case ENTITY_TYPES.STAG:
            context.fillStyle = "rgb(92, 59, 36)";
            playerSize = 16;
            break;
        };
        context.fillRect(x - playerSize/2, y - playerSize/2, playerSize, playerSize);
      };

      socket.on(CONNECT, () => {
        socketId = socket.id;
      })

      socket.on(WORLDSTATE, worldStateString => {
        // Get the canvas
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");

        context.canvas.width = window.innerWidth;
        context.canvas.height = window.innerHeight;

        // Set the background
        context.fillStyle = "rgb(32, 128, 53)";
        context.fillRect(0, 0, canvas.width, canvas.height);

        // Draw all players
        const worldState = JSON.parse(worldStateString);
        const entities = worldState.entities;
        // const me = entities.filter(entity => entity.id === socketId)[0];
        const me = entities.filter(entity => entity.type === "stag")[0];
        for (const entity of entities) {
          drawEntity(entity, me.position);
        };
      });

      document.addEventListener(ON_KEY_DOWN, (event) => {
        socket.emit(EVENT, {
          action: ON_KEY_DOWN,
          key: event.key
        });
      });

      document.addEventListener(ON_KEY_UP, (event) => {
        socket.emit(EVENT, {
          action: ON_KEY_UP,
          key: event.key
        });
      });

    </script>
  </body>
</html>
