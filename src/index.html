<!doctype html>
<html>
  <head>
    <title>Stag Hunt</title>
  </head>
  <body>
    <canvas id="canvas" width=1400 height=700></canvas>
    <script src="/socket.io/socket.io.js"></script>

    <script>

      const ON_KEY_DOWN = "keydown";
      const ON_KEY_UP = "keyup";
      const EVENT = "event";
      const WORLDSTATE = "worldstate";
      const ENTITY_TYPES = {
        PLAYER: "player",
        RABBIT: "rabbit",
        STAG: "stag"
      };

      const socket = io();

      const drawEntity = (entity) => {
        // Get the canvas
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");

        // Get the entity data
        const entityPosition = entity.position;
        const { x, y } = entityPosition;
        let playerSize = null;

        // Draw the entity
        switch (entity.type) {
          case ENTITY_TYPES.PLAYER:
            context.fillStyle = entity.color;
            playerSize = 10;
            break;
          case ENTITY_TYPES.RABBIT:
            context.fillStyle = "rgb(196, 188, 183)";
            playerSize = 8;
            break;
          case ENTITY_TYPES.STAG:
            context.fillStyle = "rgb(92, 59, 36)";
            playerSize = 16;
            break;
        };
        context.fillRect(x - playerSize/2, y - playerSize/2, playerSize, playerSize);
      };

      socket.on(WORLDSTATE, worldState => {
        console.log(worldState);

        // Get the canvas
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");

        // Set the background
        context.fillStyle = "rgb(32, 128, 53)";
        context.fillRect(0, 0, canvas.width, canvas.height);

        // Draw all players
        for (const entity of JSON.parse(worldState).entities) {
          drawEntity(entity);
        };
      });

      document.addEventListener(ON_KEY_DOWN, (event) => {
        console.log("Key down:", event.key);
        socket.emit(EVENT, {
          action: ON_KEY_DOWN,
          key: event.key
        });
      });


      document.addEventListener(ON_KEY_UP, (event) => {
        console.log("Key up:", event.key);
        socket.emit(EVENT, {
          action: ON_KEY_UP,
          key: event.key
        });
      });

    </script>
  </body>
</html>
